Describe gina#command#commit
  Before all
    let Path = vital#gina#import('System.Filepath')
    let root = tempname()
    let slit1 = Slit(Path.join(root, 'valid'), 1)
    call slit1.write('A/foo.txt', [])
    call slit1.write('B/foo.txt', [])
    call slit1.write('C/foo.txt', [])
    call slit1.execute('add .')
  End

  After all
    let File = vital#gina#import('System.File')
    call File.rmdir(root, 'r')
    call gina#core#clear()
  End

  Describe Use cases
    Before
      execute 'edit' fnameescape(slit1.worktree)
    End

    It might be called without arguments
      GinaSync commit
      Assert Equals(winnr('$'), 2)
      Assert Equals(bufname('%'), 'gina://valid:commit')
      Assert Equals(getline(1, '$'), [
            \ '',
            \ '# Please enter the commit message for your changes. Lines starting',
            \ '# with ''#'' will be ignored, and an empty message aborts the commit.',
            \ '# On branch master',
            \ '#',
            \ '# Initial commit',
            \ '#',
            \ '# Changes to be committed:',
            \ "#\tnew file:   A/foo.txt",
            \ "#\tnew file:   B/foo.txt",
            \ "#\tnew file:   C/foo.txt",
            \ '#',
            \])

      call append(0, 'Test Message')
      Assert Equals(slit1.execute('log -1 --one-line'), [''])
    End
  End

  Describe #cleanup_commitmsg({content}, {mode}, {comment})
    Before
      let SCISSOR = '------------------------ >8 ------------------------'
    End

    Context {mode} == 'default'
      Before
        let mode = 'default'
        let comment = '#'
      End

      It strips leading and trailing empty lines from {content}
        let content = ['', '', '', 'a', 'b', 'c', '', '', '']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ 'a',
              \ 'b',
              \ 'c',
              \])
      End

      It strips trailing whitespace from {content}
        let content = ['  a  ', 'b  ', '  c']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ '  a',
              \ 'b',
              \ '  c',
              \])
      End

      It DOES NOT strip content after a scissor
        let content = ['a', 'b', 'c', '# ' . SCISSOR, 'd', 'e', 'f']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ 'a',
              \ 'b',
              \ 'c',
              \ '',
              \ 'd',
              \ 'e',
              \ 'f',
              \])
      End

      It strips commentary from {content}
        let content = ['Not a commentary', '# A commentary', 'Not # a commentary']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ 'Not a commentary',
              \ '',
              \ 'Not # a commentary',
              \])

        let content = ['Not a commentary', '^ A commentary', 'Not ^ a commentary']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, '^'), [
              \ 'Not a commentary',
              \ '',
              \ 'Not ^ a commentary',
              \])
      End

      It collapse consecutiv empty lines
        let content = ['a', '', 'b', '', '', 'c', '', '', '', 'd']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ 'a',
              \ '',
              \ 'b',
              \ '',
              \ 'c',
              \ '',
              \ 'd',
              \])
      End
    End

    Context {mode} == 'strip'
      Before
        let mode = 'strip'
        let comment = '#'
      End

      It strips leading and trailing empty lines from {content}
        let content = ['', '', '', 'a', 'b', 'c', '', '', '']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ 'a',
              \ 'b',
              \ 'c',
              \])
      End

      It strips trailing whitespace from {content}
        let content = ['  a  ', 'b  ', '  c']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ '  a',
              \ 'b',
              \ '  c',
              \])
      End

      It DOES NOT strip content after a scissor
        let content = ['a', 'b', 'c', '# ' . SCISSOR, 'd', 'e', 'f']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ 'a',
              \ 'b',
              \ 'c',
              \ '',
              \ 'd',
              \ 'e',
              \ 'f',
              \])
      End

      It strips commentary from {content}
        let content = ['Not a commentary', '# A commentary', 'Not # a commentary']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ 'Not a commentary',
              \ '',
              \ 'Not # a commentary',
              \])

        let content = ['Not a commentary', '^ A commentary', 'Not ^ a commentary']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, '^'), [
              \ 'Not a commentary',
              \ '',
              \ 'Not ^ a commentary',
              \])
      End

      It collapse consecutiv empty lines
        let content = ['a', '', 'b', '', '', 'c', '', '', '', 'd']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ 'a',
              \ '',
              \ 'b',
              \ '',
              \ 'c',
              \ '',
              \ 'd',
              \])
      End
    End

    Context {mode} == 'whitespace'
      Before
        let mode = 'whitespace'
        let comment = '#'
      End

      It strips leading and trailing empty lines from {content}
        let content = ['', '', '', 'a', 'b', 'c', '', '', '']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ 'a',
              \ 'b',
              \ 'c',
              \])
      End

      It strips trailing whitespace from {content}
        let content = ['  a  ', 'b  ', '  c']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ '  a',
              \ 'b',
              \ '  c',
              \])
      End

      It DOES NOT strip content after a scissor
        let content = ['a', 'b', 'c', '# ' . SCISSOR, 'd', 'e', 'f']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ 'a',
              \ 'b',
              \ 'c',
              \ '# ' . SCISSOR,
              \ 'd',
              \ 'e',
              \ 'f',
              \])
      End

      It DOES NOT strip commentary from {content}
        let content = ['Not a commentary', '# A commentary', 'Not # a commentary']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ 'Not a commentary',
              \ '# A commentary',
              \ 'Not # a commentary',
              \])

        let content = ['Not a commentary', '^ A commentary', 'Not ^ a commentary']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, '^'), [
              \ 'Not a commentary',
              \ '^ A commentary',
              \ 'Not ^ a commentary',
              \])
      End

      It collapse consecutiv empty lines
        let content = ['a', '', 'b', '', '', 'c', '', '', '', 'd']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ 'a',
              \ '',
              \ 'b',
              \ '',
              \ 'c',
              \ '',
              \ 'd',
              \])
      End
    End

    Context {mode} == 'scissors'
      Before
        let mode = 'scissors'
        let comment = '#'
      End

      It strips leading and trailing empty lines from {content}
        let content = ['', '', '', 'a', 'b', 'c', '', '', '']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ 'a',
              \ 'b',
              \ 'c',
              \])
      End

      It strips trailing whitespace from {content}
        let content = ['  a  ', 'b  ', '  c']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ '  a',
              \ 'b',
              \ '  c',
              \])
      End

      It strips content after a scissor
        let content = ['a', 'b', 'c', '# ' . SCISSOR, 'd', 'e', 'f']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ 'a',
              \ 'b',
              \ 'c',
              \])
      End

      It strips commentary from {content}
        let content = ['Not a commentary', '# A commentary', 'Not # a commentary']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ 'Not a commentary',
              \ '',
              \ 'Not # a commentary',
              \])

        let content = ['Not a commentary', '^ A commentary', 'Not ^ a commentary']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, '^'), [
              \ 'Not a commentary',
              \ '',
              \ 'Not ^ a commentary',
              \])
      End

      It collapse consecutiv empty lines
        let content = ['a', '', 'b', '', '', 'c', '', '', '', 'd']
        Assert Equals(gina#command#commit#cleanup_commitmsg(content, mode, comment), [
              \ 'a',
              \ '',
              \ 'b',
              \ '',
              \ 'c',
              \ '',
              \ 'd',
              \])
      End
    End
  End
End
